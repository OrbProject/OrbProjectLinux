name: Release Linux Installers

on:
  release:
    types: [published]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    env:
      # Tag name of the GitHub release (ex: "v1.2.0")
      VERSION: ${{ github.event.release.tag_name }}

    steps:
      # ----------------------------------------------------
      # 0. Checkout (utile pour le manifeste Flatpak, etc.)
      # ----------------------------------------------------
      - uses: actions/checkout@v4

      # ----------------------------------------------------
      # 1. Outils nécessaires au packaging
      # ----------------------------------------------------
      - name: Install packaging dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential unzip imagemagick libfuse2 \
              flatpak flatpak-builder \
              ruby-dev zlib1g-dev libffi-dev
          gem install --no-document fpm

      # ----------------------------------------------------
      # 2. Récupération du build Unity (archive .zip)
      # ----------------------------------------------------
      - name: Download Unity Linux build
        env:
          BUILD_URL: "https://builds.orbprojectmanagement.com/Linux/"
        run: |
          curl -L "$BUILD_URL" -o Build_Linux.zip
          unzip -q Build_Linux.zip
          # L'archive crée un dossier "Build_Linux" tel que montré sur la capture.

      # ----------------------------------------------------
      # 3. Récupération / conversion de l'icône
      # ----------------------------------------------------
      - name: Download & convert icon to PNG
        env:
          ICON_URL: "https://builds.orbprojectmanagement.com/Images/logo.ico"
        run: |
          curl -L "$ICON_URL" -o icon_source
          # Convertit BMP/ICO → PNG haute résolution (512×512).
          convert icon_source -resize 512x512\> icon.png

      # ----------------------------------------------------
      # 4. Préparation de l'AppDir (base commune)
      # ----------------------------------------------------
      - name: Prepare AppDir structure
        run: |
          # Copie tous les fichiers du build Unity dans /usr/share/OrbProject
          mkdir -p AppDir/usr/share/OrbProject
          cp -r Build_Linux/* AppDir/usr/share/OrbProject/

          # Crée un lanceur "OrbProject" dans /usr/bin
          mkdir -p AppDir/usr/bin
          cat > AppDir/usr/bin/OrbProject <<'EOF'
          #!/bin/sh
          HERE="$(dirname "$(readlink -f "$0")")"
          exec "$HERE/../share/OrbProject/OrbProject.x86_64" "$@"
          EOF
          chmod +x AppDir/usr/bin/OrbProject

          # Icône et fichier .desktop (AppImage / Flatpak / paquets)
          cp icon.png AppDir/OrbProject.png
          cat > AppDir/OrbProject.desktop <<'EOF'
          [Desktop Entry]
          Name=OrbProject
          Exec=OrbProject
          Icon=OrbProject
          Type=Application
          Categories=Game;
          EOF

      # ----------------------------------------------------
      # 5. AppImage
      # ----------------------------------------------------
      - name: Build AppImage
        uses: appimagecrafters/build-appimage@v1
        with:
          appdir: AppDir
          output: OrbProject-${{ env.VERSION }}.AppImage

      # ----------------------------------------------------
      # 6. Paquet .deb
      # ----------------------------------------------------
      - name: Build .deb package
        run: |
          fpm -s dir -t deb -n OrbProject -v ${VERSION#v} \
              --architecture amd64 \
              --maintainer "Ton Nom <email@example.com>" \
              --license MIT \
              --description "Mon jeu Unity pour Linux" \
              --url "https://github.com/${{ github.repository }}" \
              --depends "libgtk-3-0" --depends "libnss3" \
              -C AppDir usr

      # ----------------------------------------------------
      # 7. Paquet .rpm
      # ----------------------------------------------------
      - name: Build .rpm package
        run: |
          fpm -s dir -t rpm -n OrbProject -v ${VERSION#v} \
              --architecture x86_64 \
              --license MIT \
              --url "https://github.com/${{ github.repository }}" \
              --depends "gtk3" \
              -C AppDir usr

      # ----------------------------------------------------
      # 8. Flatpak
      # ----------------------------------------------------
      - name: Build Flatpak bundle
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: packaging/${{ secrets.APP_ID }}.yml
          repo-name: repo
          bundle: OrbProject-${{ env.VERSION }}.flatpak
          cache: true
          archs: x86_64

      # ----------------------------------------------------
      # 9. Publication des artefacts dans la release
      # ----------------------------------------------------
      - name: Upload installers to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.AppImage
            *.deb
            *.rpm
            *.flatpak
