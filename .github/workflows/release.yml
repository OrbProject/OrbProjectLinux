name: Package and Release Linux Builds

on:
  release:
    types: [created]  # Déclenche l'action uniquement lors de la création d'une release

jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Récupérer le numéro de version depuis la release
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Afficher la structure des fichiers
        run: ls -R

      - name: Préparer .deb (Debian/Ubuntu)
        run: |
          mkdir -p debian/DEBIAN debian/usr/lib/orbproject debian/usr/bin
          
          # Vérifier l'existence des fichiers avant copie
          ls OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* || exit 1
          
          cp -r OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* debian/usr/lib/orbproject/
          chmod +x debian/usr/lib/orbproject/OrbProject.x86_64
          ln -s /usr/lib/orbproject/OrbProject.x86_64 debian/usr/bin/orbproject

          echo "Package: orbproject
          Version: $VERSION
          Section: games
          Priority: optional
          Architecture: amd64
          Depends: libc6
          Maintainer: TonNom <ton.email@example.com>
          Description: Un jeu fait avec Unity" > debian/DEBIAN/control

          dpkg-deb --build debian OrbProject_${VERSION}_amd64.deb &> build_deb.log

      - name: Préparer .rpm (Fedora/RedHat)
        run: |
          mkdir -p rpm/usr/lib/orbproject rpm/usr/bin
          
          ls OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* || exit 1
          
          cp -r OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* rpm/usr/lib/orbproject/
          chmod +x rpm/usr/lib/orbproject/OrbProject.x86_64
          ln -s /usr/lib/orbproject/OrbProject.x86_64 rpm/usr/bin/orbproject

          cat <<EOF > orbproject.spec
          Name: orbproject
          Version: ${VERSION}
          Release: 1
          Summary: Un jeu fait avec Unity
          License: Proprietary
          Group: Games
          BuildArch: x86_64
          Requires: libc.so.6

          %description
          Un jeu Unity packagé pour Fedora.

          %install
          mkdir -p %{buildroot}/usr/lib/orbproject %{buildroot}/usr/bin
          cp -r rpm/usr/lib/orbproject %{buildroot}/usr/lib/
          ln -s /usr/lib/orbproject/OrbProject.x86_64 %{buildroot}/usr/bin/orbproject

          %files
          /usr/lib/orbproject
          /usr/bin/orbproject

          %post
          echo 'Installation terminée!'
          EOF

          rpmbuild -bb orbproject.spec --buildroot=$PWD/rpm &> build_rpm.log
        shell: bash

      - name: Installer et vérifier Flatpak
        run: |
          sudo apt update && sudo apt install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Platform//21.08
          sudo flatpak install -y flathub org.freedesktop.Sdk//21.08
          flatpak --version
          flatpak list

      - name: Générer Flatpak
        run: |
          mkdir -p flatpak/app/lib/orbproject
          cp -r OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* flatpak/app/lib/orbproject/
          chmod +x flatpak/app/lib/orbproject/OrbProject.x86_64
          
          if [ ! -f flatpak/app/lib/orbproject/OrbProject.x86_64 ]; then
            echo "❌ Erreur : OrbProject.x86_64 n'a pas été copié correctement."
            exit 1
          fi
          
          cat <<EOF > orbproject.flatpak.json
          {
            "app-id": "com.orbproject.OrbProject",
            "runtime": "org.freedesktop.Platform",
            "runtime-version": "21.08",
            "sdk": "org.freedesktop.Sdk",
            "command": "/app/lib/orbproject/OrbProject.x86_64",
            "modules": [
              {
                "name": "orbproject",
                "buildsystem": "simple",
                "build-commands": [
                  [ "install", "-D", "-m", "755", "flatpak/app/lib/orbproject/OrbProject.x86_64", "/app/lib/orbproject/OrbProject.x86_64" ]
                ],
                "sources": [
                  {
                    "type": "dir",
                    "path": "flatpak/app"
                  }
                ]
              }
            ]
          }
          EOF

          flatpak-builder --repo=repo build-dir orbproject.flatpak.json --force-clean
          flatpak build-bundle repo OrbProject_${VERSION}.flatpak com.orbproject.OrbProject

      - name: Upload Artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            OrbProject_${VERSION}_amd64.deb
            OrbProject_${VERSION}_x86_64.rpm
            OrbProject_${VERSION}.flatpak
