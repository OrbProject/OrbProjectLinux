name: Release Linux Installers

on:
  release:
    types: [published]

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    env:
      VERSION: ${{ github.event.release.tag_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Install packaging dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential unzip imagemagick libfuse2 \
              flatpak flatpak-builder \
              ruby-dev zlib1g-dev libffi-dev
          sudo gem install --no-document fpm

      - name: Download Unity Linux build
        env:
          BUILD_URL: "https://builds.orbprojectmanagement.com/Linux/Build_Linux.zip"
          ZIP_FILE: Build_Linux.zip
        run: |
          echo "Fetching $ZIP_FILE from $BUILD_URL"
          curl -fL "$BUILD_URL" -o "$ZIP_FILE"
          if [ $(stat --printf="%s" "$ZIP_FILE") -lt 1048576 ]; then
            echo "::error::Downloaded ZIP is too small to be valid." >&2
            exit 1
          fi
          unzip -q "$ZIP_FILE"

      - name: Download icon PNG directly
        env:
          ICON_URL: "https://builds.orbprojectmanagement.com/Images/Logo.png"
        run: |
          curl -fL "$ICON_URL" -o icon.png

      - name: Prepare AppDir structure
        run: |
          mkdir -p AppDir/usr/share/OrbProject
          cp -r Build_Linux/* AppDir/usr/share/OrbProject/

          mkdir -p AppDir/usr/bin
          cat > AppDir/usr/bin/OrbProject <<'EOF'
          #!/bin/sh
          HERE="$(dirname \"$(readlink -f \"$0\")")"
          exec "$HERE/../share/OrbProject/OrbProject.x86_64" "$@"
          EOF
          chmod +x AppDir/usr/bin/OrbProject

          cp icon.png AppDir/OrbProject.png
          cat > AppDir/OrbProject.desktop <<'EOF'
          [Desktop Entry]
          Name=OrbProject
          Exec=OrbProject
          Icon=OrbProject
          Type=Application
          Categories=Game;
          EOF

      #- name: Build AppImage
        #uses: appimagecrafters/build-appimage@v1
       # with:
         # entryPoint: packaging/AppImageBuilder.yml

      - name: Build .deb package
        run: |
          fpm -s dir -t deb -n OrbProject -v ${VERSION#v} \
              --architecture amd64 \
              --maintainer "orbProject <noreply@orbprojectmanagement.com>" \
              --license MIT \
              --description "Orb Project Management" \
              --url "https://github.com/${{ github.repository }}" \
              --depends "libgtk-3-0" --depends "libnss3" \
              -C AppDir usr

      - name: Build .rpm package
        run: |
          fpm -s dir -t rpm -n OrbProject -v ${VERSION#v} \
              --architecture x86_64 \
              --license MIT \
              --url "https://github.com/${{ github.repository }}" \
              --depends "gtk3" \
              -C AppDir usr

      - name: Build Flatpak bundle
        uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          manifest-path: packaging/${{ secrets.APP_ID }}.yml
          repo-name: repo
          bundle: OrbProject-${{ env.VERSION }}.flatpak
          cache: true
          archs: x86_64

      - name: Upload installers to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            *.AppImage
            *.deb
            *.rpm
            *.flatpak
