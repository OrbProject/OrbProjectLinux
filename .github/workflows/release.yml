name: Package and Release Linux Builds

on:
  release:
    types: [created]  # D√©clenche l'action uniquement lors de la cr√©ation d'une release

permissions:
  contents: write


jobs:
  package:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: R√©cup√©rer le num√©ro de version depuis la release
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: Afficher la structure des fichiers
        run: ls -R

      - name: Pr√©parer .deb (Debian/Ubuntu)
        run: |
          mkdir -p debian/DEBIAN
          mkdir -p debian/usr/lib/orbproject
          mkdir -p debian/usr/bin

          cp -r OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* debian/usr/lib/orbproject/
          ln -s /usr/lib/orbproject/OrbProject.x86_64 debian/usr/bin/orbproject

          echo "Package: orbproject
          Version: $VERSION
          Section: games
          Priority: optional
          Architecture: amd64
          Depends: libc6
          Maintainer: TonNom <ton.email@example.com>
          Description: Un jeu fait avec Unity" > debian/DEBIAN/control

          dpkg-deb --build debian OrbProject_${VERSION}_amd64.deb

      - name: Sauvegarder le fichier .deb
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: OrbProject_${{ env.VERSION }}_amd64.deb

      - name: Cr√©er les dossiers et copier les fichiers
        run: |
          mkdir -p $PWD/rpm/usr/lib/orbproject
          mkdir -p $PWD/rpm/usr/bin
      
          # V√©rifie que les fichiers existent avant de les copier
          ls -l OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* || exit 1
      
          cp -r OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* $PWD/rpm/usr/lib/orbproject/
          ln -s /usr/lib/orbproject/OrbProject.x86_64 $PWD/rpm/usr/bin/orbproject
      
      - name: V√©rifier le contenu des r√©pertoires
        run: |
          echo "üìÅ Contenu de /home/runner/rpmbuild/BUILD/rpm avant copie :"
          mkdir -p /home/runner/rpmbuild/BUILD/rpm/usr/lib/orbproject  # Cr√©ation du dossier ici !
          ls -R /home/runner/rpmbuild/BUILD/rpm || echo "‚ùå Le r√©pertoire rpm n'existe pas"
      
          echo "üìÅ Contenu du dossier source (o√π se trouvent les fichiers √† copier) :"
          ls -l $PWD/rpm/usr/lib/orbproject || echo "‚ùå Le dossier source est vide ou inexistant"
      
      - name: G√©n√©rer le fichier spec et construire le RPM
        run: |
          cat <<EOF > orbproject.spec
          Name: orbproject
          Version: ${VERSION}
          Release: 1
          Summary: Un jeu fait avec Unity
          License: Proprietary
          Group: Games
          BuildArch: x86_64
          Requires: libc.so.6

          %description
          Un jeu Unity packag√© pour Fedora.

          %install
          mkdir -p %{buildroot}/usr/lib/orbproject
          mkdir -p %{buildroot}/usr/bin
          cp -r rpm/usr/lib/orbproject %{buildroot}/usr/lib/ || echo "‚ö†Ô∏è Probl√®me de copie !"
          ln -s /usr/lib/orbproject/OrbProject.x86_64 %{buildroot}/usr/bin/orbproject

          %files
          /usr/lib/orbproject
          /usr/bin/orbproject

          %post
          echo 'Installation termin√©e!'
          EOF

          rpmbuild -bb orbproject.spec --buildroot=$PWD/rpm
      - name: V√©rifier le fichier RPM g√©n√©r√©
        run: |
          echo "üìÅ Liste des fichiers RPM g√©n√©r√©s :"
          find ~/rpmbuild/RPMS/ -name "*.rpm" || echo "‚ùå AUCUN fichier RPM trouv√© !"

      - name: Copier le RPM dans le dossier de build
        run: |
          mkdir -p artifacts
          cp $HOME/rpmbuild/RPMS/x86_64/*.rpm artifacts/
          
        shell: bash
        env:
          VERSION: ${{ env.VERSION }}

      - name: Sauvegarder le fichier RPM
        uses: actions/upload-artifact@v4
        with:
          name: rpm-package
          path: artifacts/*.rpm

      - name: Installer les d√©pendances Flatpak
        run: |
          sudo apt update && sudo apt install -y flatpak flatpak-builder
          sudo flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
          sudo flatpak install -y flathub org.freedesktop.Platform//21.08
          sudo flatpak install -y flathub org.freedesktop.Sdk//21.08

      - name: V√©rifier installation de Flatpak et des SDK
        run: |
          flatpak --version
          flatpak list

      - name: G√©n√©rer le fichier de configuration Flatpak
        run: |
          cat <<EOF > orbproject.flatpak.json
          {
            "app-id": "com.orbproject.OrbProject",
            "runtime": "org.freedesktop.Platform",
            "runtime-version": "21.08",
            "sdk": "org.freedesktop.Sdk",
            "command": "/app/bin/orbproject",
            "modules": [
              {
                "name": "orbproject",
                "buildsystem": "simple",
                "build-commands": [
                  "install -D -m 755 bin/orbproject /app/bin/orbproject"
                ],
                "sources": [
                  {
                    "type": "dir",
                    "path": "flatpak/app"
                  }
                ]
              }
            ]
          }
          EOF

      - name: Pr√©parer les fichiers pour Flatpak
        run: |
          mkdir -p flatpak/app/lib/orbproject
          mkdir -p flatpak/app/bin
          
          cp -vr OrbProject.x86_64 OrbProject_Data UnityPlayer.so libdecor-*.so* flatpak/app/lib/orbproject/
          cp flatpak/app/lib/orbproject/OrbProject.x86_64 flatpak/app/bin/orbproject

          chmod +x flatpak/app/bin/orbproject

          # V√©rifier si l'ex√©cutable est bien copi√©
          echo "üìÅ V√©rification des fichiers apr√®s copie :"
          ls -l flatpak/app/bin/orbproject || exit 1

      - name: Construire le Flatpak
        run: |
          echo "üìÅ Contenu du dossier Flatpak avant la construction :"
          ls -lR flatpak/app/ || exit 1  # V√©rifier la structure compl√®te

          echo "üìÅ Chemin actuel :"
          pwd

          # Utiliser un chemin absolu pour √©viter des probl√®mes de chemin relatif
          flatpak-builder --repo=repo build-dir orbproject.flatpak.json --force-clean
          flatpak build-bundle repo OrbProject_${VERSION}.flatpak com.orbproject.OrbProject

      - name: Upload Artifacts to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            OrbProject_${{ env.VERSION }}_amd64.deb
            artifacts/*.rpm
            OrbProject_${{ env.VERSION }}.flatpak
            
  publish-apt:
    runs-on: ubuntu-latest
    needs: package

    steps:
      - name: R√©cup√©rer le num√©ro de version depuis la release
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV

      - name: T√©l√©charger le fichier .deb
        uses: actions/download-artifact@v4
        with:
          name: deb-package
          path: .

      - name: Installer Aptly
        run: |
          sudo apt-get update
          sudo apt-get install -y aptly

      - name: Cr√©er le r√©pertoire Aptly
        run: mkdir -p aptly_repo

      - name: Installer et initialiser GPG
        run: |
          sudo apt update && sudo apt install -y gpg
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
      
          # G√©n√©rer une cl√© GPG si elle n'existe pas d√©j√†
          gpg --batch --gen-key <<EOF
          %no-protection
          Key-Type: RSA
          Key-Length: 4096
          Name-Real: OrbProject
          Name-Email: orbproject@example.com
          Expire-Date: 0
          %commit
          EOF
      
          # V√©rifier que la cl√© a bien √©t√© cr√©√©e
          gpg --list-keys

      - name: Configurer Aptly avec GPG
        run: |
          mkdir -p ~/.aptly
          cat <<EOF > ~/.aptly.conf
          {
            "gpg": {
              "batch": true,
              "default-key": "OrbProject"
            }
          }
          EOF

          # V√©rifier si le fichier est bien valide
          cat /home/runner/.aptly.conf
          
      - name: Cr√©er le d√©p√¥t Aptly si n√©cessaire
        run: |
          aptly repo show orbproject-repo || aptly repo create -distribution=bullseye -component=main orbproject-repo

      - name: Publier avec Aptly
        run: |
          aptly repo list
          aptly repo add orbproject-repo OrbProject_${VERSION}_amd64.deb
          aptly publish repo -batch orbproject-repo

      - name: Configurer la cl√© SSH pour Git
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.APT_REPO_TOKEN }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Cloner le d√©p√¥t APT
        run: git clone --depth 1 https://github.com/OrbProject/OrbProject-apt.git OrbProject-apt

      - name: Configurer l'identit√© Git
        run: |
          git config --global user.email "eitelhugo10@gmail.com"
          git config --global user.name "Eitel Hugo"

      - name: V√©rifier et cr√©er le r√©pertoire OrbProject-apt
        run: |
          mkdir -p OrbProject-apt

      - name: Copier les fichiers dans le d√©p√¥t APT
        run: |
          cp -r aptly_repo/public/* OrbProject-apt/

      - name: Mettre √† jour le d√©p√¥t APT
        run: |
          cd OrbProject-apt
          git add .
          git commit -m "Mise √† jour du d√©p√¥t APT pour OrbProject v${VERSION}"
          git push

  publish-yum:
    runs-on: ubuntu-latest
    needs: package

    steps:
      - name: R√©cup√©rer le num√©ro de version depuis la release
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_ENV
        
      - name: Installer createrepo-c
        run: sudo apt update && sudo apt install -y createrepo-c

      - name: T√©l√©charger le fichier RPM
        uses: actions/download-artifact@v4
        with:
          name: rpm-package
          path: artifacts

      - name: V√©rifier l'acc√®s SSH √† GitHub
        run: ssh -T git@github.com || echo "‚ùå Impossible de se connecter √† GitHub via SSH"

      - name: Cloner le d√©p√¥t YUM
        run: git clone --depth 1 https://github.com/OrbProject/OrbProject-yum.git yum_repo_git
     
      - name: V√©rifier si le d√©p√¥t YUM a bien √©t√© clon√©
        run: ls -la yum_repo_git || echo "‚ùå Le dossier yum_repo_git est vide !"
      
      - name: Configurer la cl√© SSH pour Git
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.YUM_REPO_TOKEN }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: Forcer Git √† utiliser SSH au lieu de HTTPS
        run: |
          cd yum_repo_git
          git remote set-url origin git@github.com:OrbProject/OrbProject-yum.git

      - name: Configurer l'identit√© Git pour YUM
        run: |
          git config --global user.email "eitelhugo10@gmail.com"
          git config --global user.name "Hugo Eitel"

      - name: Cr√©er le d√©p√¥t YUM
        run: |
          mkdir -p yum_repo
          cp artifacts/*.rpm yum_repo/
          createrepo_c yum_repo/

      - name: Copier les fichiers dans le d√©p√¥t YUM
        run: |
          cp -r yum_repo/* yum_repo_git/

      - name: Mettre √† jour le d√©p√¥t YUM
        run: |
          cd yum_repo_git
          git add .
          git commit -m "Mise √† jour du d√©p√¥t YUM pour OrbProject v${VERSION}"
          git push

  #publish-flatpak:
     #runs-on: ubuntu-latest
    #needs: package

#    steps:
    #  - name: Installer Flatpak et configurer Flathub
   #     run: |
        #  sudo apt update && sudo apt install -y flatpak flatpak-builder
       #   flatpak remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo

     # - name: D√©ployer sur Flathub
      #  run: |
   #       flatpak build-bundle repo OrbProject_${{ env.VERSION }}.flatpak com.orbproject.OrbProject
         # flatpak build-import-bundle repo OrbProject_${{ env.VERSION }}.flatpak


